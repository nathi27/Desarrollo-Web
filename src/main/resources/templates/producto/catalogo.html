<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{general/fragmentos :: head}"></head>
<body>
    
    <header th:replace="~{general/fragmentos :: header}"></header>

    <section class="py-5 mb-3 text-center text-white" style="background: linear-gradient(135deg, #d48c9d 0%, #f3d1dc 100%);">
        <div class="container">
            <h1 class="display-4 brand-font">Catálogo</h1>
            <p class="lead">Elige tus favoritos y recíbelos frescos</p>
        </div>
    </section>

    <!-- SECCIÓN DE FILTROS -->
    <div class="container mb-4">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="card-title text-primary mb-3">
                    <i class="fas fa-filter me-2"></i>Filtrar Productos
                </h5>
                
                <form id="filtroForm" method="get" th:action="@{/catalogo}" class="row g-3">
                    <!-- Filtro por Categoría -->
                    <div class="col-md-6">
                        <label for="categoria" class="form-label fw-bold">Categoría</label>
                        <select id="categoria" name="categoria" class="form-select">
                            <option value="">Todas las categorías</option>
                            <option th:each="cat : ${categorias}" 
                                    th:value="${cat}"
                                    th:text="${cat}"
                                    th:selected="${filtro != null and filtro.categoria == cat}">
                            </option>
                        </select>
                    </div>
                    
                    <!-- Buscar por Nombre -->
                    <div class="col-md-6">
                        <label for="nombre" class="form-label fw-bold">Buscar por nombre</label>
                        <div class="input-group">
                            <input type="text" id="nombre" name="nombre" 
                                   class="form-control" 
                                   placeholder="Ej: Pie, Galleta, Pastel..."
                                   th:value="${filtro != null ? filtro.nombre : ''}">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="col-12 mt-2">
                        <div class="d-grid gap-2 d-md-flex">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-filter me-2"></i>Aplicar Filtros
                            </button>
                            <a th:href="@{/catalogo}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-times me-2"></i>Limpiar Filtros
                            </a>
                        </div>
                    </div>
                </form>
                
                <!-- filtros activos -->
                <div th:if="${filtroAplicado}" class="mt-3">
                    <div class="alert alert-info py-2 mb-0">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            Mostrando productos filtrados. 
                            <a th:href="@{/catalogo}" class="alert-link">Ver todos</a>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        
        <!-- SECCIÓN: Pies & Tortas -->
        <div class="category-section mb-5" th:if="${!productosPiesTortas.empty}">
            <div class="d-flex align-items-center mb-4">
                <h2 class="brand-font text-primary me-3">Pies & Tortas</h2>
                <span class="badge bg-primary rounded-pill" 
                      th:text="${productosPiesTortas.size()}">0</span>
                <div class="flex-grow-1 border-bottom border-2" style="border-color: #f3d1dc !important;"></div>
            </div>
            
            <div class="row g-4">
                <div class="col-md-6 col-lg-3" th:each="p, iterStat : ${productosPiesTortas}">
                    <div class="card h-100 border-0 shadow-sm product-card">
                        <div class="position-relative">
                            <!-- IMÁGENES PARA PIES & TORTAS - CORRECTO -->
                            <img th:if="${iterStat.index % 4 == 0}"
                                 src="https://images.unsplash.com/photo-1621743478914-cc8a86d7e7b5?q=80&w=1374&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" alt="Pie de manzana" style="height: 220px; object-fit: cover;">
                            <img th:if="${iterStat.index % 4 == 1}"
                                 src="https://images.unsplash.com/photo-1583350229873-e06b12acdb9c?q=80&w=1444&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" alt="Pie de limón" style="height: 220px; object-fit: cover;">
                            <img th:if="${iterStat.index % 4 == 2}"
                                 src="https://plus.unsplash.com/premium_photo-1722686461601-b2a018a4213b?q=80&w=955&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" alt="Torta chilena" style="height: 220px; object-fit: cover;">
                            <img th:if="${iterStat.index % 4 == 3}"
                                 src="https://images.unsplash.com/photo-1641848373324-bc744c442d5b?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" alt="Pavlova" style="height: 220px; object-fit: cover;">
                            
                            <span class="position-absolute top-0 end-0 bg-success text-white px-3 py-1 m-2 rounded-pill small fw-bold" 
                                  th:if="${p.stock > 0}">Disponible</span>
                            <span class="position-absolute top-0 end-0 bg-secondary text-white px-3 py-1 m-2 rounded-pill small fw-bold" 
                                  th:if="${p.stock == 0}">Agotado</span>
                        </div>
                        
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold" th:text="${p.nombre}">Nombre del Pie</h5>
                            <p class="card-text text-muted small flex-grow-1" th:text="${p.descripcion}">Descripción deliciosa...</p>
                            
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="fs-5 fw-bold text-primary" th:text="'₡' + ${#numbers.formatDecimal(p.precio, 0, 'COMMA', 0, 'POINT')}">₡3,000</span>
                                <span th:if="${p.stock > 0}" class="badge bg-light text-dark">
                                    <i class="fas fa-box me-1"></i><span th:text="${p.stock}"></span> disponibles
                                </span>
                            </div>
                            
                            <div class="d-grid gap-2 mt-3">
                                <a th:href="@{/producto/__${p.idProducto}__}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Ver Detalles
                                </a>
                                <button class="btn btn-primary btn-sm" 
                                        th:onclick="agregarAlCarrito([[${p.idProducto}]], [[${p.nombre}]], [[${p.precio}]], [[${p.descripcion}]])"
                                        th:disabled="${p.stock == 0}">
                                    <i class="fas fa-cart-plus me-1"></i>Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÓN: Macarons & Donas -->
        <div class="category-section mb-5" th:if="${!productosMacarons.empty}">
            <div class="d-flex align-items-center mb-4">
                <h2 class="brand-font text-primary me-3">Macarons & Donas</h2>
                <span class="badge bg-primary rounded-pill" 
                      th:text="${productosMacarons.size()}">0</span>
                <div class="flex-grow-1 border-bottom border-2" style="border-color: #f3d1dc !important;"></div>
            </div>
            <div class="row g-4">
                <div class="col-md-6 col-lg-3" th:each="p, iterStat : ${productosMacarons}">
                    <div class="card h-100 border-0 shadow-sm product-card">
                        <div class="position-relative">
                            <!-- IMÁGENES PARA MACARONS & DONAS - CORREGIDO -->
                            <img th:if="${iterStat.index % 3 == 0}"
                                 src="https://plus.unsplash.com/premium_photo-1670604211960-82b8d84f6aea?q=80&w=1632&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Macarons">
                            <img th:if="${iterStat.index % 3 == 1}"
                                 src="https://images.unsplash.com/photo-1527515545081-5db817172677?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Donas">
                            <img th:if="${iterStat.index % 3 == 2}"
                                 src="https://images.unsplash.com/photo-1512325605119-b10de50ecba9?q=80&w=1474&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Brownies">
                            
                            <span class="position-absolute top-0 end-0 bg-success text-white px-3 py-1 m-2 rounded-pill small fw-bold" th:if="${p.stock > 0}">Disponible</span>
                            <span class="position-absolute top-0 end-0 bg-secondary text-white px-3 py-1 m-2 rounded-pill small fw-bold" th:if="${p.stock == 0}">Agotado</span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold" th:text="${p.nombre}">Nombre</h5>
                            <p class="card-text text-muted small flex-grow-1" th:text="${p.descripcion}">Descripción...</p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="fs-5 fw-bold text-primary" th:text="'₡' + ${#numbers.formatDecimal(p.precio, 0, 'COMMA', 0, 'POINT')}">Price</span>
                                <span th:if="${p.stock > 0}" class="badge bg-light text-dark">
                                    <i class="fas fa-box me-1"></i><span th:text="${p.stock}"></span> disponibles
                                </span>
                            </div>
                            <div class="d-grid gap-2 mt-3">
                                <a th:href="@{/producto/__${p.idProducto}__}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Ver Detalles
                                </a>
                                <button class="btn btn-primary btn-sm" th:onclick="agregarAlCarrito([[${p.idProducto}]], [[${p.nombre}]], [[${p.precio}]], [[${p.descripcion}]])" th:disabled="${p.stock == 0}">
                                    <i class="fas fa-cart-plus me-1"></i>Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÓN: Galletas & Brookies -->
        <div class="category-section mb-5" th:if="${!productosGalletas.empty}">
            <div class="d-flex align-items-center mb-4">
                <h2 class="brand-font text-primary me-3">Galletas & Brookies</h2>
                <span class="badge bg-primary rounded-pill" 
                      th:text="${productosGalletas.size()}">0</span>
                <div class="flex-grow-1 border-bottom border-2" style="border-color: #f3d1dc !important;"></div>
            </div>
            <div class="row g-4">
                <div class="col-md-6 col-lg-3" th:each="p, iterStat : ${productosGalletas}">
                    <div class="card h-100 border-0 shadow-sm product-card">
                        <div class="position-relative">
                            <!-- IMÁGENES PARA GALLETAS & BROOKIES - CORREGIDO -->
                            <img th:if="${iterStat.index % 3 == 0}"
                                 src="https://plus.unsplash.com/premium_photo-1677554828437-9f5b42dca722?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Galletas personalizadas">
                            <img th:if="${iterStat.index % 3 == 1}"
                                 src="https://plus.unsplash.com/premium_photo-1669727914945-e5f2394a2e96?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Galletas corazón">
                            <img th:if="${iterStat.index % 3 == 2}"
                                 src="https://plus.unsplash.com/premium_photo-1663046018870-dde03c0a34f7?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Brookies">
                            
                            <span class="position-absolute top-0 end-0 bg-success text-white px-3 py-1 m-2 rounded-pill small fw-bold" th:if="${p.stock > 0}">Disponible</span>
                            <span class="position-absolute top-0 end-0 bg-secondary text-white px-3 py-1 m-2 rounded-pill small fw-bold" th:if="${p.stock == 0}">Agotado</span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold" th:text="${p.nombre}">Nombre</h5>
                            <p class="card-text text-muted small flex-grow-1" th:text="${p.descripcion}">Descripción...</p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="fs-5 fw-bold text-primary" th:text="'₡' + ${#numbers.formatDecimal(p.precio, 0, 'COMMA', 0, 'POINT')}">Price</span>
                                <span th:if="${p.stock > 0}" class="badge bg-light text-dark">
                                    <i class="fas fa-box me-1"></i><span th:text="${p.stock}"></span> disponibles
                                </span>
                            </div>
                            <div class="d-grid gap-2 mt-3">
                                <a th:href="@{/producto/__${p.idProducto}__}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Ver Detalles
                                </a>
                                <button class="btn btn-primary btn-sm" th:onclick="agregarAlCarrito([[${p.idProducto}]], [[${p.nombre}]], [[${p.precio}]], [[${p.descripcion}]])" th:disabled="${p.stock == 0}">
                                    <i class="fas fa-cart-plus me-1"></i>Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÓN: Pasteles de Celebración -->
        <div class="category-section mb-5" th:if="${!productosPasteles.empty}">
            <div class="d-flex align-items-center mb-4">
                <h2 class="brand-font text-primary me-3">Pasteles de Celebración</h2>
                <span class="badge bg-primary rounded-pill" 
                      th:text="${productosPasteles.size()}">0</span>
                <div class="flex-grow-1 border-bottom border-2" style="border-color: #f3d1dc !important;"></div>
            </div>
            <div class="row g-4">
                <div class="col-md-6 col-lg-3" th:each="p, iterStat : ${productosPasteles}">
                    <div class="card h-100 border-0 shadow-sm product-card">
                        <div class="position-relative">
                            <!-- IMÁGENES PARA PASTELES DE CELEBRACIÓN - CORRECTO -->
                            <img th:if="${iterStat.index % 4 == 0}"
                                 src="https://images.unsplash.com/photo-1578985545158-1f66043e36a9?q=80&w=1374&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Pasteles clásicos">
                            <img th:if="${iterStat.index % 4 == 1}"
                                 src="https://images.unsplash.com/photo-1590528817134-cec6f4de7e14?q=80&w=1471&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Pasteles personalizados">
                            <img th:if="${iterStat.index % 4 == 2}"
                                 src="https://images.unsplash.com/photo-1624993014250-fc6877db3222?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Pasteles fríos">
                            <img th:if="${iterStat.index % 4 == 3}"
                                 src="https://images.unsplash.com/photo-1713274787530-5955bded42a4?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                                 class="card-img-top rounded-top" style="height: 220px; object-fit: cover;" alt="Lunch cake">
                            
                            <span class="position-absolute top-0 end-0 bg-success text-white px-3 py-1 m-2 rounded-pill small fw-bold" th:if="${p.stock > 0}">Disponible</span>
                            <span class="position-absolute top-0 end-0 bg-secondary text-white px-3 py-1 m-2 rounded-pill small fw-bold" th:if="${p.stock == 0}">Agotado</span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold" th:text="${p.nombre}">Nombre</h5>
                            <p class="card-text text-muted small flex-grow-1" th:text="${p.descripcion}">Descripción...</p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="fs-5 fw-bold text-primary" th:text="'₡' + ${#numbers.formatDecimal(p.precio, 0, 'COMMA', 0, 'POINT')}">Price</span>
                                <span th:if="${p.stock > 0}" class="badge bg-light text-dark">
                                    <i class="fas fa-box me-1"></i><span th:text="${p.stock}"></span> disponibles
                                </span>
                            </div>
                            <div class="d-grid gap-2 mt-3">
                                <a th:href="@{/producto/__${p.idProducto}__}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Ver Detalles
                                </a>
                                <button class="btn btn-primary btn-sm" th:onclick="agregarAlCarrito([[${p.idProducto}]], [[${p.nombre}]], [[${p.precio}]], [[${p.descripcion}]])" th:disabled="${p.stock == 0}">
                                    <i class="fas fa-cart-plus me-1"></i>Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mensaje cuando no hay resultados -->
        <div th:if="${productosPiesTortas.empty and productosMacarons.empty and productosGalletas.empty and productosPasteles.empty}"
             class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-search fa-4x text-muted"></i>
            </div>
            <h4 class="text-muted mb-3">No se encontraron productos</h4>
            <p class="text-muted mb-4">Intenta con otros criterios de búsqueda o 
                <a th:href="@{/catalogo}" class="text-primary">ver todos los productos</a>
            </p>
        </div>
        
    </div>

    <footer th:replace="~{general/fragmentos :: footer}"></footer>
    
    <!-- Script para mejorar los filtros -->
    <script>
        
        document.getElementById('categoria').addEventListener('change', function() {
            if(this.value) {
                document.getElementById('filtroForm').submit();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // Actualiza contador de carrito
            actualizarContadorCarrito();
        });
    </script>
    
    <style>
        .product-card {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1) !important;
        }
        .product-card img {
            transition: transform 0.5s ease;
        }
        .product-card:hover img {
            transform: scale(1.05);
        }
        
        /* Estilo para filtros */
        .form-control:focus, .form-select:focus {
            border-color: #d48c9d;
            box-shadow: 0 0 0 0.25rem rgba(212, 140, 157, 0.25);
        }
        
        .btn-primary {
            background-color: #d48c9d;
            border-color: #d48c9d;
        }
        .btn-primary:hover {
            background-color: #c17a8c;
            border-color: #c17a8c;
        }
        
        .badge.bg-primary {
            background-color: #d48c9d !important;
        }
        
        .category-section {
            transition: opacity 0.3s ease;
        }
    </style>
    
    <!-- Script del carrito -->
    <script>
       function obtenerCarrito() {
           const carrito = localStorage.getItem('carritoPasteleria');
           return carrito ? JSON.parse(carrito) : [];
       }

       function guardarCarrito(carrito) {
           localStorage.setItem('carritoPasteleria', JSON.stringify(carrito));
       }

       function agregarAlCarrito(id, nombre, precio, descripcion) {
           const carrito = obtenerCarrito();
           const productoExistente = carrito.find(item => item.id === id);
           
           if (productoExistente) {
               productoExistente.cantidad += 1;
           } else {
               carrito.push({
                   id: id, nombre: nombre, precio: precio, descripcion: descripcion, cantidad: 1
               });
           }
           
           guardarCarrito(carrito);
           actualizarContadorCarrito();
           
           alert("¡" + nombre + " agregado al carrito!");
       }
       
       function actualizarContadorCarrito() {
           const carrito = obtenerCarrito();
           const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
           const cartBadge = document.querySelector('.cart-badge');
           if (cartBadge) {
               cartBadge.textContent = totalItems;
               cartBadge.style.display = totalItems > 0 ? 'inline' : 'none';
           }
       }
    </script>
</body>
</html>