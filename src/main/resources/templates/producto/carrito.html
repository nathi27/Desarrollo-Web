<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{general/fragmentos :: head}">
        <style>
            
            .hero-section {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 60px 0;
                text-align: center;
                margin-bottom: 40px;
            }
            .cart-container {
                max-width: 1200px;
                margin: 0 auto;
            }
            .cart-item {
                background: white;
                border-radius: 15px;
                padding: 25px;
                margin-bottom: 20px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                border: 1px solid #e9ecef;
                transition: all 0.3s ease;
            }
            .cart-item:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }
            .product-image {
                width: 80px;
                height: 80px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                color: #6c757d;
            }
            .quantity-controls {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .quantity-btn {
                width: 40px;
                height: 40px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            .quantity-btn:hover {
                background: #667eea;
                color: white;
            }
            .quantity-input {
                width: 60px;
                text-align: center;
                border: 2px solid #e9ecef;
                border-radius: 10px;
                padding: 8px;
                font-weight: bold;
            }
            .remove-btn {
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 8px;
                padding: 8px 15px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            .remove-btn:hover {
                background: #c82333;
                transform: scale(1.05);
            }
            .price-section {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 15px;
                padding: 30px;
                margin-top: 30px;
            }
            .summary-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 0;
                border-bottom: 1px solid #dee2e6;
            }
            .summary-total {
                font-size: 1.5rem;
                font-weight: bold;
                color: #28a745;
                border-bottom: none;
            }
            .checkout-btn {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                border: none;
                color: white;
                padding: 15px 30px;
                border-radius: 25px;
                font-weight: bold;
                font-size: 1.1rem;
                width: 100%;
                margin-top: 20px;
                transition: all 0.3s ease;
            }
            .checkout-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
            }
            .continue-shopping {
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 25px;
                border-radius: 25px;
                text-decoration: none;
                display: inline-block;
                transition: all 0.3s ease;
            }
            .continue-shopping:hover {
                background: #5a6268;
                color: white;
                transform: translateY(-2px);
            }
            .empty-cart {
                text-align: center;
                padding: 60px 20px;
                color: #6c757d;
            }
            .empty-cart i {
                font-size: 4rem;
                margin-bottom: 20px;
                opacity: 0.5;
            }
            .stock-warning {
                color: #dc3545;
                font-size: 0.9rem;
                margin-top: 5px;
                display: none;
            }
            .subtotal {
                font-weight: bold;
                color: #495057;
                font-size: 1.1rem;
            }

            
            .checkout-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
        </style>
    </head>
    <body>
        <header th:replace="~{general/fragmentos :: header}"></header>

        <main>
            <section class="hero-section">
                <div class="container">
                    <h1 class="display-5 fw-bold mb-3">Carrito de Compras</h1>
                    <p class="lead mb-0">Revisa y gestiona tus productos seleccionados</p>
                </div>
            </section>

            <section class="container py-4">
                <div class="cart-container">
                    <div id="emptyCart" class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Tu carrito está vacío</h3>
                        <p class="mb-4">Agrega algunos productos deliciosos para comenzar</p>
                        <a th:href="@{/catalogo}" class="continue-shopping">
                            <i class="fas fa-arrow-left me-2"></i>Continuar Comprando
                        </a>
                    </div>

                    <div id="cartWithItems" style="display: none;">
                        <div class="row">
                            <div class="col-lg-8">
                                <div id="cartItemsContainer">
                                </div>
                                <div class="text-start mt-3">
                                    <a th:href="@{/catalogo}" class="continue-shopping">
                                        <i class="fas fa-arrow-left me-2"></i>Continuar Comprando
                                    </a>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="price-section">
                                    <h4 class="mb-4">Resumen del Pedido</h4>

                                    <div class="summary-item">
                                        <span>Subtotal:</span>
                                        <span id="subtotal">₡0.00</span>
                                    </div>

                                    <div class="summary-item">
                                        <span>Envío:</span>
                                        <span>₡2,000.00</span>
                                    </div>

                                    <div class="summary-item">
                                        <span>Impuestos (13%):</span>
                                        <span id="taxes">₡0.00</span>
                                    </div>

                                    <div class="summary-item summary-total">
                                        <span>Total:</span>
                                        <span id="total">₡0.00</span>
                                    </div>

                                    <div class="payment-methods mt-4 mb-4">
                                        <h5 class="mb-3">Método de Pago</h5>

                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="metodoPago" id="pagoSinpe" value="Sinpe Móvil">
                                            <label class="form-check-label" for="pagoSinpe">
                                                <i class="fas fa-mobile-alt me-2 text-primary"></i> Sinpe Móvil
                                            </label>
                                        </div>

                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="metodoPago" id="pagoTarjeta" value="Tarjeta">
                                            <label class="form-check-label" for="pagoTarjeta">
                                                <i class="fas fa-credit-card me-2 text-warning"></i> Tarjeta Débito/Crédito
                                            </label>
                                        </div>

                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="metodoPago" id="pagoEfectivo" value="Efectivo">
                                            <label class="form-check-label" for="pagoEfectivo">
                                                <i class="fas fa-money-bill-wave me-2 text-success"></i> Efectivo contra entrega
                                            </label>
                                        </div>
                                    </div>

                                    <div class="delivery-methods mt-4 mb-4">
                                        <h5 class="mb-3">Método de Entrega</h5>

                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="metodoEntrega" id="entregaDomicilio" value="Entrega a domicilio">
                                            <label class="form-check-label" for="entregaDomicilio">
                                                <i class="fas fa-truck me-2 text-info"></i> Entrega a domicilio
                                            </label>
                                        </div>

                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="metodoEntrega" id="retiroTienda" value="Retiro en tienda">
                                            <label class="form-check-label" for="retiroTienda">
                                                <i class="fas fa-store me-2 text-secondary"></i> Retiro en tienda
                                            </label>
                                        </div>
                                    </div>


                                    <button class="checkout-btn" onclick="procesarPago()" id="btnFinalizar" disabled>
                                        <i class="fas fa-check-circle me-2"></i>Seleccione un método de pago
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer th:replace="~{general/fragmentos :: footer}"></footer>

        <script>
            
            const stockDisponible = {
                1: 10, 2: 8, 3: 6, 4: 12, 5: 15, 6: 20, 7: 18, 8: 25, 9: 30, 10: 22, 11: 8, 12: 6, 13: 10, 14: 15
            };

            function obtenerCarrito() {
                const carrito = localStorage.getItem('carritoPasteleria');
                return carrito ? JSON.parse(carrito) : [];
            }

            function guardarCarrito(carrito) {
                localStorage.setItem('carritoPasteleria', JSON.stringify(carrito));
            }

            function agregarAlCarrito(id, nombre, precio, descripcion) {
                const carrito = obtenerCarrito();
                const productoExistente = carrito.find(item => item.id === id);

                if (productoExistente) {
                    if (productoExistente.cantidad < stockDisponible[id]) {
                        productoExistente.cantidad += 1;
                        mostrarMensaje('Producto agregado al carrito', 'success');
                    } else {
                        mostrarMensaje('Cantidad mayor al stock disponible', 'error');
                        return;
                    }
                } else {
                    carrito.push({
                        id: id, nombre: nombre, precio: precio, descripcion: descripcion, cantidad: 1
                    });
                    mostrarMensaje('Producto agregado al carrito', 'success');
                }

                guardarCarrito(carrito);
                actualizarContadorCarrito();
            }

            function eliminarDelCarrito(id) {
                const carrito = obtenerCarrito();
                const nuevoCarrito = carrito.filter(item => item.id !== id);
                guardarCarrito(nuevoCarrito);
                renderizarCarrito();
                actualizarContadorCarrito();
                mostrarMensaje('Producto eliminado del carrito', 'info');
            }

            function actualizarCantidad(id, nuevaCantidad) {
                if (nuevaCantidad < 1) {
                    eliminarDelCarrito(id);
                    return;
                }
                if (nuevaCantidad > stockDisponible[id]) {
                    mostrarMensaje('Cantidad mayor al stock disponible', 'error');
                    nuevaCantidad = stockDisponible[id];
                }
                const carrito = obtenerCarrito();
                const producto = carrito.find(item => item.id === id);
                if (producto) {
                    producto.cantidad = nuevaCantidad;
                    guardarCarrito(carrito);
                    renderizarCarrito();
                    actualizarContadorCarrito();
                }
            }

            function renderizarCarrito() {
                const carrito = obtenerCarrito();
                const cartItemsContainer = document.getElementById('cartItemsContainer');
                const emptyCart = document.getElementById('emptyCart');
                const cartWithItems = document.getElementById('cartWithItems');

                if (carrito.length === 0) {
                    emptyCart.style.display = 'block';
                    cartWithItems.style.display = 'none';
                    return;
                }

                emptyCart.style.display = 'none';
                cartWithItems.style.display = 'block';

                let html = '';
                let subtotal = 0;

                carrito.forEach(item => {
                    const itemSubtotal = item.precio * item.cantidad;
                    subtotal += itemSubtotal;

                    html += `
                        <div class="cart-item">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <div class="product-image"><i class="fas fa-birthday-cake"></i></div>
                                </div>
                                <div class="col-md-4">
                                    <h5 class="mb-1">${item.nombre}</h5>
                                    <p class="text-muted mb-0 small">${item.descripcion}</p>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-md-center">
                                        <span class="price-unit">₡${item.precio.toLocaleString()}</span>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="quantity-controls">
                                        <button class="quantity-btn" onclick="actualizarCantidad(${item.id}, ${item.cantidad - 1})">-</button>
                                        <input type="number" class="quantity-input" value="${item.cantidad}" min="1" max="${stockDisponible[item.id]}" onchange="actualizarCantidad(${item.id}, parseInt(this.value))">
                                        <button class="quantity-btn" onclick="actualizarCantidad(${item.id}, ${item.cantidad + 1})">+</button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-end">
                                        <span class="subtotal">₡${itemSubtotal.toLocaleString()}</span>
                                        <br>
                                        <button class="remove-btn mt-2" onclick="eliminarDelCarrito(${item.id})"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });

                cartItemsContainer.innerHTML = html;

               
                const envio = 2000;
                const impuestos = subtotal * 0.13;
                const total = subtotal + envio + impuestos;

                document.getElementById('subtotal').textContent = `₡${subtotal.toLocaleString()}`;
                document.getElementById('taxes').textContent = `₡${impuestos.toLocaleString()}`;
                document.getElementById('total').textContent = `₡${total.toLocaleString()}`;
            }

            function actualizarContadorCarrito() {
                const carrito = obtenerCarrito();
                const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
                const cartBadge = document.querySelector('.cart-badge');
                if (cartBadge) {
                    cartBadge.textContent = totalItems;
                    cartBadge.style.display = totalItems > 0 ? 'inline' : 'none';
                }
            }

            function mostrarMensaje(mensaje, tipo) {
                const toast = document.createElement('div');
                toast.className = `alert alert-${tipo === 'error' ? 'danger' : tipo} alert-dismissible fade show`;
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
                toast.innerHTML = `${mensaje} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.body.appendChild(toast);
                setTimeout(() => {
                    if (toast.parentNode)
                        toast.parentNode.removeChild(toast);
                }, 3000);
            }

           

            document.addEventListener('DOMContentLoaded', function () {
                renderizarCarrito();
                actualizarContadorCarrito();

                
                const radiosPago = document.getElementsByName('metodoPago');
                const btnFinalizar = document.getElementById('btnFinalizar');

                radiosPago.forEach(radio => {
                    radio.addEventListener('change', function () {
                        btnFinalizar.disabled = false;
                        btnFinalizar.innerHTML = '<i class="fas fa-check-circle me-2"></i>Finalizar Compra';
                    });
                });
            });

            
            function procesarPago() {
                const carrito = obtenerCarrito();

                if (!document.querySelector('input[name="metodoPago"]:checked')) {
                    mostrarMensaje('Por favor selecciona un método de pago', 'error');
                    return;
                }

                const metodoSeleccionado = document.querySelector('input[name="metodoPago"]:checked').value;

                let subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                let envio = 2000;
                let impuestos = subtotal * 0.13;
                let total = subtotal + envio + impuestos;

                const datosCompra = {
                    metodoPago: metodoSeleccionado,
                    total: total,
                    items: carrito
                };

                const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

                const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : null;
                const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : null;

                
                fetch('/checkout/procesar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken && csrfHeader ? { [csrfHeader]: csrfToken } : {})
                    },
                    body: JSON.stringify(datosCompra)
                })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                localStorage.removeItem('carritoPasteleria'); 
                                window.location.href = '/checkout/confirmacion/' + data.idPedido; 
                            } else {
                                mostrarMensaje('Error al procesar el pedido: ' + (data.message || ''), 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            mostrarMensaje('Error de conexión', 'error');
                        });
            }
        </script>
    </body>
</html>
